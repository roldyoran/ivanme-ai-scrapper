name: Run OpenCode MCP

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt para OpenCode MCP'
        required: true
        default: |
          Usa el MCP de Playwright para automatizar la siguiente tarea:

          1 Navega a la url: 'https://www.ivanime.com/paste/3329422/'
              1.1 En dado caso de que la página no cargue correctamente o encuentre un challenge de Cloudflare, usa curl para obtener el HTML y cargarlo en Playwright
              1.2 También extrae el título del anime de la página original
          2. Busca la card de descarga con calidad 1080p que indica 1.3GB
          3. Encuentra el último enlace MFIRE dentro de esa card
          4. Haz clic en ese enlace para navegar a la página de ouo.io
          5. Espera que cargue la página de ouo.io completamente
          6. Resuelve automáticamente el captcha de ouo.io usando:
              - Espera inteligente hasta que aparezca el botón de continuar
              - Si hay checkbox 'Im a Human', haz clic en él y espera la validación
              - Espera los 6 segundos necesarios hasta que se habilite el botón de 'Get Link'
              - Haz clic en 'Get Link' para proceder
          8. Espera la redirección final a MFIRE
          9. Extrae la URL final de MFIRE

          Devuelve EXCLUSIVAMENTE una RESPUESTA DE TU PARTE con un objeto JSON con esta estructura:
          {
            \"titulo\": \"[Nombre del anime extraído]\",
            \"link\": \"[URL final de MFIRE]\",
            \"capitulo\": \"[Número del capitulo]\",
            \"calidad\": \"1080p\"
          }

          Requisitos importantes:
              - No incluyas explicaciones, comentarios o texto adicional
              - Si algún paso falla, reintenta con lógica de fallback
              - Usa selectores robustos (data attributes, clases específicas)
              - Maneja timeouts adecuados (mínimo 30 segundos de esperaen pasos críticos)
              - Para el captcha: usa waitForSelector y lógica dedetección automática
              - Si la redirección tarda, aumenta los timeouts gradualmente
              - Verifica que el enlace final sea válido (contenga 'mfire'o dominio similar)
              - Cierra el navegador al finalizar
        type: string

jobs:
  run-opencode:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js LTS
      uses: actions/setup-node@v3
      with:
        node-version: 'lts/*'

    - name: Install OpenCode
      run: |
        curl -fsSL https://opencode.ai/install | bash
        echo 'export PATH="$HOME/.opencode/bin:$PATH"' >> $GITHUB_ENV

    - name: Run OpenCode MCP
      env:
        OPENCODE_PROMPT: ${{ github.event.inputs.prompt }}
      run: |
        # Agregar OpenCode al PATH para este step
        export PATH="$HOME/.opencode/bin:$PATH"
        opencode run "$OPENCODE_PROMPT"